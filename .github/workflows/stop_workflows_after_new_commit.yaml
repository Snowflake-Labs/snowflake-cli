name: Stop older workflows after new commit is pushed

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  stop_running_workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Install npm deps
        run: |
          npm install @octokit/rest
          npm install node-fetch@2

      - name: Cancel previous workflows
        uses: actions/github-script@v7
        with:
          script: |
            const { Octokit } = require("@octokit/rest");
            const octokit = new Octokit(
              auth: process.env.GITHUB_TOKEN
            });

            const repo_owner = process.env.GITHUB_REPOSITORY.split("/")[0];
            const repo = process.env.GITHUB_REPOSITORY.split("/")[1];
            const pull_number = process.env.GITHUB_EVENT_NUMBER;
            const head = process.env.COMMIT_SHA

            const runs = octokit.rest.actions.listWorkflowRunsForRepo({
              repo_owner,
              repo,
              status: "in_progress" })
            .filter( run => {
              return run.pull_requests.some (pr => pr.number == pull_number) && run.head_sha !== head;
            })
            .map( run => {
              return octokit.actions.cancelWorkflowRun({
              owner,
              repo,
              run_id: run.id
              })
            }
            );
